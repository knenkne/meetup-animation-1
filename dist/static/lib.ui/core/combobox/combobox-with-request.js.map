{"version":3,"file":"combobox-with-request.js","sources":["../../src/combobox/combobox-with-request.jsx"],"sourcesContent":["import React from 'react'\nimport PropTypes from 'prop-types'\nimport _ from 'lodash'\n\nimport { canBeRequestedByTyping, canBeRequestedByScrolling } from './utils'\nimport { ComboboxView } from './combobox-view'\n\n/**\n * Семантическое текстовое поле с выпадающим списком с локальным хранением данных и динамической работой по таймаутам\n *\n * @param {Object} props - свойства компонента\n * @return {JSX} - компонент\n */\nexport class ComboboxWithRequest extends React.Component {\n    static propTypes = {\n        value: PropTypes.string,\n        onChange: PropTypes.func,\n        onChangeOption: PropTypes.func,\n        onChangeInput: PropTypes.func,\n        onBlur: PropTypes.func,\n        placeholder: PropTypes.string,\n        initialValue: PropTypes.string,\n        /**\n         * Первоначальный state.query\n         */\n        initialQuery: PropTypes.string,\n        /**\n         * Первоначальный state.options\n         */\n        options: PropTypes.arrayOf(PropTypes.shape({\n            title: PropTypes.string,\n            description: PropTypes.string,\n            value: PropTypes.string.isRequired,\n            icon: PropTypes.string\n        })),\n        /**\n         * Тект для обработки случаев: не найдено совпадений, долгая загрузка, ошибка загрузки, повторить загрузку\n         */\n        translations: PropTypes.shape({\n            requestTimeout: PropTypes.string,\n            noMatches: PropTypes.string,\n            repeat: PropTypes.string,\n            requestError: PropTypes.string\n        }),\n        a11y: PropTypes.shape({\n            optionsLabel: PropTypes.string.isRequired,\n        }).isRequired,\n        /**\n         * Обязательный timeout между последним вводом и возможностью вызова onDataRequest\n         */\n        keyboardTimeout: PropTypes.number,\n        /**\n         * Обязательный timeout между началом запроса и включением mode=\"long\"\n         */\n        requestTimeout: PropTypes.number,\n        /**\n         * Запрос данных; получает на вход query - введенную строку\n         */\n        onDataRequest: PropTypes.func,\n        /**\n         * Включение пагинации на скролл\n         */\n        withPagination: PropTypes.bool,\n    }\n\n    static defaultProps = {\n        value: void 0,\n        onChange: _.noop,\n        onChangeOption: _.noop,\n        onChangeInput: _.noop,\n        onBlur: _.noop,\n        initialQuery: void 0,\n        initialValue: void 0,\n        options: [],\n        keyboardTimeout: 0,\n        requestTimeout: void 0,\n        onDataRequest: _.noop,\n        placeholder: void 0,\n        translations: {\n            requestTimeout: void 0,\n            noMatches: void 0,\n            repeat: void 0,\n            requestError: void 0,\n        },\n        withPagination: false\n    }\n\n    state = {\n        query:\n            this.props.initialQuery ||\n            this.props.options.find(\n                (option) => option?.value === this.props.initialValue)?.title || this.props.initialValue || '',\n        options: this.props.options,\n        isLoading: false,\n        isLongRequest: false,\n        isAlreadyRequested: false,\n        isFetchError: false,\n        isFullSuggestLoaded: false\n    }\n\n    getCurrentOption = (value) => _.find(this.state.options, { value })\n\n    handleChangeInput = (query, event) => {\n        clearTimeout(this.requestTimer)\n        const { value, keyboardTimeout } = this.props\n\n        this.setState({\n            query,\n            options: [],\n            isFullSuggestLoaded: false,\n            isAlreadyRequested: false,\n            isFetchError: false\n        })\n\n        this.props.onChangeInput(query, event)\n\n        if (canBeRequestedByTyping(query, value)) {\n            this.requestTimer = setTimeout(() => {\n                this.makeRequest(query)\n            }, keyboardTimeout)\n        }\n    }\n\n    handleScroll = (event) => {\n        const { query, isFullSuggestLoaded, isLoading } = this.state\n        const { value, withPagination } = this.props\n\n        if (canBeRequestedByScrolling(withPagination, event, isFullSuggestLoaded, isLoading)\n            && canBeRequestedByTyping(query, value)\n        ) {\n            this.makeRequest(query, true)\n        }\n    }\n\n    handleChangeOption = (value) => {\n        const query = this.getCurrentOption(value).title\n        this.setState({\n            query\n        })\n\n        this.props.onChangeOption(value, query)\n    }\n\n    handleRetry = () => {\n        this.makeRequest(this.state.query)\n    }\n\n    async makeRequest (query, isAdding) {\n        clearTimeout(this.longRequestTimer)\n\n        this.setState({\n            isLoading: true,\n            isLongRequest: false\n        })\n\n        const requestParams = { query }\n\n        this.recentRequest = requestParams\n\n        if (this.props.requestTimeout) {\n            this.longRequestTimer = setTimeout(() => {\n                this.setState({\n                    isLongRequest: true\n                })\n            }, this.props.requestTimeout)\n        }\n\n        try {\n            const suggestions = await this.props.onDataRequest(requestParams, isAdding)\n\n            if (!suggestions) {\n                this.setState({\n                    isLoading: false,\n                    isFetchError: false,\n                    isFullSuggestLoaded: true,\n                    isLongRequest: false,\n                    isAlreadyRequested: true\n\n                })\n            } else if (_.isEqual(this.recentRequest, requestParams)) {\n                this.setState({\n                    isLoading: false,\n                    options: isAdding ? _.concat(this.state.options, suggestions) : suggestions,\n                    isFetchError: false,\n                    isFullSuggestLoaded: _.isEmpty(suggestions),\n                    isLongRequest: false,\n                    isAlreadyRequested: true\n                })\n            }\n        } catch (error) {\n            if (_.isEqual(this.recentRequest, requestParams)) {\n                this.setState({\n                    isLoading: false,\n                    options: [],\n                    isFetchError: true,\n                    isFullSuggestLoaded: false,\n                    isLongRequest: false,\n                    isAlreadyRequested: true\n                })\n            }\n            throw new Error(error)\n        } finally {\n            clearTimeout(this.longRequestTimer)\n        }\n    }\n\n    render () {\n        const { query, options, isLoading, isLongRequest, isFetchError, isAlreadyRequested } = this.state\n\n        let requestMode\n\n        if (isLongRequest) {\n            requestMode = 'long'\n        } else if (isFetchError) {\n            requestMode = 'error'\n        } else if (_.isEmpty(options) && query && isAlreadyRequested) {\n            requestMode = 'noMatches'\n        }\n        return (\n            <ComboboxView\n                {...this.props}\n                options={options}\n                requestMode={requestMode}\n                isLoading={isLoading}\n                onChangeOption={this.handleChangeOption}\n                onChangeInput={this.handleChangeInput}\n                onRetry={this.handleRetry}\n                onScroll={this.handleScroll}\n            />\n        )\n    }\n}\n\nComboboxWithRequest.displayName = 'Combobox.WithRequest'\n\nexport default ComboboxWithRequest\n"],"names":["ComboboxWithRequest","query","props","initialQuery","options","find","option","value","initialValue","title","isLoading","isLongRequest","isAlreadyRequested","isFetchError","isFullSuggestLoaded","_","state","event","clearTimeout","requestTimer","keyboardTimeout","setState","onChangeInput","canBeRequestedByTyping","setTimeout","makeRequest","withPagination","canBeRequestedByScrolling","getCurrentOption","onChangeOption","isAdding","longRequestTimer","requestParams","recentRequest","requestTimeout","onDataRequest","suggestions","isEqual","concat","isEmpty","Error","requestMode","handleChangeOption","handleChangeInput","handleRetry","handleScroll","React","Component","PropTypes","string","onChange","func","onBlur","placeholder","arrayOf","shape","description","isRequired","icon","translations","noMatches","repeat","requestError","a11y","optionsLabel","number","bool","noop","displayName"],"mappings":"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"}