{"version":3,"file":"utils.js","sources":["../../src/markdown/utils.js"],"sourcesContent":["/* eslint-disable camelcase, comment: кейсинг предоставляет Remarkable */\r\nimport _ from 'lodash'\r\nimport Remarkable from 'remarkable'\r\nimport { escapeHtml, replaceEntities } from 'remarkable/lib/common/utils'\r\n\r\nimport externalIcon from '../icon/common/external.svg'\r\n\r\nconst options = {\r\n    html: false,\r\n    xhtmlOut: false,\r\n    breaks: false,\r\n    langPrefix: 'language-',\r\n    linkify: false,\r\n    typographer: true,\r\n    quotes: '«»‘’'\r\n}\r\n\r\nconst internalTestRegExp = /^[#./]/\r\nconst lastWorldRegExp = /[^\\s]*$/\r\nconst nbspRegExp = /\\u00a0/g\r\nconst nbspHtmlEntity = '&nbsp;'\r\n\r\nexport const isExternalUrl = (url = '') =>\r\n    !!url && !internalTestRegExp.test(url)\r\n\r\nexport const emOpen = () => '<strong>'\r\nexport const emClose = () => '</strong>'\r\n\r\nexport const linkOpen = (tokens, idx) => {\r\n    const href = escapeHtml(tokens[idx].href)\r\n    const isExternal = isExternalUrl(href)\r\n    const title = tokens[idx].title\r\n        ? ` title=\"${escapeHtml(replaceEntities(tokens[idx].title))}\"`\r\n        : ''\r\n\r\n    if (!isExternal) {\r\n        return `<a href=\"${href}\"${title}><span>`\r\n    }\r\n\r\n    const externals = ' target=\"_blank\" rel=\"noopener noreferrer\"'\r\n    const content = escapeHtml(tokens[idx + 1].content)\r\n    const droppedLast = content.replace(lastWorldRegExp, '')\r\n\r\n    return `<a href=\"${href}\"${title}${externals}>${droppedLast ? '<span>' : ''}`\r\n}\r\n\r\nexport const linkClose = (tokens, idx) => {\r\n    const href = escapeHtml(tokens[idx - 2].href) // eslint-disable-line no-magic-numbers, comment: приходят все токены, а href лежит в два токена слева: <a> и текст\r\n    if (!isExternalUrl(href)) {\r\n        return '</span></a>'\r\n    }\r\n\r\n    const content = escapeHtml(tokens[idx - 1].content)\r\n    const droppedLast = content.replace(lastWorldRegExp, '')\r\n    const lastWord = content.match(lastWorldRegExp)[0]\r\n\r\n    return `${droppedLast ? '</span>' : ''}<span>${lastWord}${externalIcon}</span></a>`\r\n}\r\n\r\nexport const text = (tokens, idx) => {\r\n    const content = escapeHtml(tokens[idx].content)\r\n    const href = escapeHtml(tokens[idx - 1]?.href)\r\n\r\n    if (!isExternalUrl(href)) {\r\n        return content\r\n    }\r\n\r\n    return content.replace(lastWorldRegExp, '')\r\n}\r\n\r\nexport const replaceNbsp = (stateCore) => {\r\n    stateCore.src = stateCore.src?.replace(nbspRegExp, nbspHtmlEntity)\r\n}\r\n\r\nconst inlineDisable = [\r\n    'backticks',\r\n    'del',\r\n    'ins',\r\n    'mark',\r\n    'footnote_inline',\r\n    'footnote_ref'\r\n]\r\nconst blockDisable = ['blockquote', 'code', 'fences']\r\nconst blockDisableAdditional = ['deflist', 'table']\r\n\r\nconst configMdCommon = () => {\r\n    const markdown = new Remarkable('full', options)\r\n\r\n    markdown.core.ruler.before('block', 'nbspReplacer', replaceNbsp)\r\n    markdown.inline.ruler.disable(inlineDisable)\r\n    markdown.renderer.rules.link_open = linkOpen\r\n    markdown.renderer.rules.link_close = linkClose\r\n    markdown.renderer.rules.em_open = emOpen\r\n    markdown.renderer.rules.em_close = emClose\r\n    markdown.renderer.rules.text = text\r\n\r\n    return markdown\r\n}\r\n\r\nconst configMdFull = () => {\r\n    const markdownFull = configMdCommon()\r\n\r\n    markdownFull.block.ruler.disable(blockDisable)\r\n\r\n    return markdownFull\r\n}\r\n\r\nconst configMdShort = () => {\r\n    const markdownShort = configMdCommon()\r\n\r\n    markdownShort.block.ruler.disable(blockDisable.concat(blockDisableAdditional))\r\n    // ignores images completely\r\n    markdownShort.renderer.rules.image = _.stubString\r\n\r\n    return markdownShort\r\n}\r\n\r\nexport const markdownFull = configMdFull()\r\n\r\nexport const markdownShort = configMdShort()\r\n"],"names":["options","html","xhtmlOut","breaks","langPrefix","linkify","typographer","quotes","internalTestRegExp","lastWorldRegExp","nbspRegExp","nbspHtmlEntity","isExternalUrl","url","test","emOpen","emClose","linkOpen","tokens","idx","href","escapeHtml","isExternal","title","replaceEntities","externals","content","droppedLast","replace","linkClose","lastWord","match","externalIcon","text","replaceNbsp","stateCore","src","inlineDisable","blockDisable","blockDisableAdditional","configMdCommon","markdown","Remarkable","core","ruler","before","inline","disable","renderer","rules","link_open","link_close","em_open","em_close","configMdFull","markdownFull","block","configMdShort","markdownShort","concat","image","_","stubString"],"mappings":"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"}