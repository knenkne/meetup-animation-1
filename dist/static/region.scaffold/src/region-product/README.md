## Продуктовый регион для обвязки СБОЛ 3.0

Регион получает данные о продуктах и отображает их в левом меню.

### Команды для запуска проекта

##### start
Запуск проекта, порт 4242 по умолчанию

##### eslint
Проверка кода по стайлгайдам и формирование отчета

##### test
Запуск jest-тестов

##### test:ui
Запуск АФТ

### Контракт данных для Message Bus

#### Как подписаться на события / как заставить продуктовый регион обновиться?

Подписки – событие, которое происходит в продуктовом регионе, которое может начать слушать ваше приложение. 

Обновление – события, которые происходят снаружи, на которые подписан продуктовый регион.

#### Подписаться на изменения в продуктовом регионе

`REGION.PRODUCT:V1:PRODUCTS.UPDATE` – подписка на получание продуктов

`REGION.PRODUCT:V1:PROFILE.UPDATE` – подписка на обновление профиля клиента

`REGION.PRODUCT:V1:EMPLOYEE.UPDATE` – подписка на обновление профиля сотрудника (SBOL.PRO)

`REGION.PRODUCT:V1:LOANS.UPDATE` – подписка на обновление списка кредитов

`REGION.PRODUCT:V1:INSURANCE.CONTRACTS.UPDATE` – подписка на обновление заключенных страховых договоров

`REGION.PRODUCT:V1:CREDITABILITY.UPDATE` – подписка на обновление кредитного потенциала

`REGION.PRODUCT:V1:INVESTMENTS.UPDATE` – подписка на обновение инвестиций

`REGION.PRODUCT:V1:LOAN.CARD.OFFER.UPDATE` - подписка на получение кредитного предложения

#### Обновить продуктовый регион

`REGION.PRODUCT:V1:PRODUCTS.REFETCH` запуск обновления списка продуктов. 
В качестве параметра передается string - тип банковского продукта. 
Значение может состоять из 0 или более значений типа ProductType, перечисленных через запятую.
Если параметр опущен, то будут передаваться все продукты, иначе – продукты всех перечисленных типов.
##### Пример:
{ showProductType: *'cards,targets,accounts,loans,imaccounts,depoAccounts,securityAccounts'* }

`REGION.PRODUCT:V1:PROFILE.REFETCH` – перезапрос профиля клиента, например, 
когда изменилась аватарка.

`REGION.PRODUCT:V1:CREDITABILITY.REFETCH` - перезапрос кредитного потенциала

`REGION.PRODUCT:V1:INSURANCE.CONTRACTS.REFETCH` –  перезапрос контрактов страховок

`REGION.PRODUCT:V1:USER.PROPERTIES.SET` – обновить userProperties с видимостью карт для продуктового региона

### Работа в репозитории

#### TL;DR

Если продукт не приходит в общем запросе `products/list.do`, создаем action в [\_\_data_\_\/actions](./__data__/actions), передаем в редьюсер чистый payload и его же прокидываем в [\_\_data_\_\/bus](./src/__data__/bus), чтобы другие регионы тоже могли подписаться.

В [\_\_data_\_\/reducer/products](./__data__/reducers/products.js) добавляем свою логику, нам нужно три типа статусов: 'LOADING', 'SUCCESS', 'ERROR'. 

Иконки продуктов берем из `@sbol/design-system`, если подходящие иконки не нашлись – связываемся с дизайнерами 

| ФИО                             | Должность             | Контакты                                  |
|---------------------------------|-----------------------|-------------------------------------------|
| Семенов Евгений Борисович       | Руководитель проектов | Semenov.E.Bor@sberbank.ru  ТГ: @eugenebee |
| Покидышев Алексей Александрович | Главный дизайнер      | Pokidyshev.A.Al@sberbank.ru               |

Если иконка нужна __срочно__, добавляем ее в локальную коллекцию. 
Пример использования локальных коллекций можно посмотреть на примере иконки переключения темы `darkMode`.

Пишем селекторы для своего продукта.

#### Категории в левом меню


[`ProductList`](./personal-menu/products/product-list.jsx) отвечает за отображение списка с продуктами и принимает следующие параметры:

| param           | type            | указать в компоненте | указать в селекторах | isRequired | description                                                |
|-----------------|-----------------|----------------------|----------------------|------------|------------------------------------------------------------|
| title           | String          |                      | •                    | •          | название категории                                         |
| type            | String          |                      | •                    |            | тип продукта                                               |
| newProductUrl   | String          |                      | •                    |            | Урл кнопки "+"                                             |
| newProductTitle | String          |                      | •                    |            | title для доступности плашки с названием продукта          |
| onListClick     | func            | •                    |                      |            | Коллбэк после открытия вкладки                             |
| refetchArray    | Array           | •                    |                      |            | см. п. Отображение загрузки и ошибки                       |
| refetchStatuses | Array           | •                    |                      |            | см. п. Отображение загрузки и ошибки                       |
| refetchMessages | Object          | •                    |                      |            | см. п. Отображение загрузки и ошибки                       |
| feature         | String          |                      | •                    |            | Фича для отображения                                       |
| content         | Array           |                      | •                    |            | Массив с продуктами                                        |
| initialOpen     | Bool            |                      | •                    |            | Открыт по умолчанию? Всегда true, если не указать обратное |
| children        | React Component | •                    |                      | •          |                                                            |

Каждый тип продукта отображается в собственном `List`, см. пример с [`Кредитами`](./personal-menu/product-list/loan-list.jsx).
Тип List'a задается [`явно`](./personal-menu/products/index.jsx) для ФП Главной v1.
Для версии ФП Главной v2 генерация плашек будет динамической (`Продолжение следует...`)

#### Параметры продукта

[`SingleProduct`](./personal-menu/single-product/single-product.jsx) используется для вывода продуктов в 
левом списке. Основные общие параметры:


| param        | type    | isRequired | description                                                 | default |
|--------------|---------|------------|-------------------------------------------------------------|---------|
| id           | Number  | •          | уникальный id продукта                                      |         |
| href         | String  | •          | ссылка на продукт                                           |         |
| name         | String  | •          | имя продукта                                                |         |
| icon         | String  | •          | имя иконки из пака @sbol/design-system либо локального пака |         |
| type         | String  |            | тип продукта                                                |         |
| notification | String  |            | иконка-уведомление для продукта                             | null    |
| message      | Message |            | текст для продукта                                          | {}      |
| isProduct    | Bool    |            | кликабельность плашки                                       | true    |
| colorScheme  | String  |            | цвет иконки продукта                                        | black   |
| currency     | Object  |            | сумма                                                       |         |

Параметры для `message`:

| param  | type   | isRequired | description                          | default |
|--------|--------|------------|--------------------------------------|---------|
| text   | String |            | дополнительная информация о продукте | null    |
| style  | String |            | параметр стиля для styled-components | null    |
| params | {}     |            | любые параметры                      | null    |

Последний параметр особенно полезен, если нужна плюрализация (склонение слова в зависимости от количества). 
[`Вклады`](./personal-menu/single-product/single-product-info/account.jsx)
демонстрируют пример использования.

Параметры для `currency`:

| param    | description                                                                                                               |
|----------|---------------------------------------------------------------------------------------------------------------------------|
| amount   | сумма                                                                                                                     |
| currency | Если oneOf['RUR', 'RUB', 'USD', 'EUR', 'JPY', 'GBP'], отображается иконка, если другое значение - отображается "как есть" |


#### Отображение продукта

Каждый продукт имеет свое закрепленное макетами в Zeplin отображение. Компонент для
продукта [выбирается](./personal-menu/single-product/single-product-info/index.jsx) с помощью параметра `type`.

| name                                   | type                      | component                  |
|----------------------------------------|---------------------------|----------------------------|
| Карты                                  | cards                     | CardInfo                   |
| Вклады                                 | accounts                  | AccountInfo                |
| ОМС (обезличенные металлические счета) | imaccounts                | ImpersonalMetalAccountInfo |
| Кредиты                                | loans                     | LoanInfo                   |
| Счета депо                             | depo                      | DepoProductInfo            |

#### Отображение загрузки и ошибки

Универсальный компонент для вывода лоадера/ошибки в любом месте продуктового региона.


| param                   | type            | description                         | default  |
|-------------------------|-----------------|-------------------------------------|----------|
| children                | React Component |                                     | null     |
| loading                 | Bool            | отобразить "Загрузку", приоритетная | false    |
| error                   | Bool            | отобразить "Ошибку"                 | false    |
| showContentWhileLoading | Bool            | показывать children пока грузится   | false    |
| showContentWhileError   | Bool            | показывать children пока ошибка     | false    |
| loaderComponent         | React Component | компонент для отображения загрузки  | () => {} |
| errorComponent          | React Component | компонент для отображения ошибки    | () => {} |

В чистом виде для разработки не нужен, однако данный компонент используется внутри ProductList и т.д.
Для того, чтобы отобразить статусы для продуктов, требуется определить 
следующие параметры для селектора списка продуктов (см. п. Категории в левом меню):

`refetchArray` – массив action'ов. Порядок action'ов должен соответствовать порядку
статусов в `refetchStatuses`

`refetchStatuses` – массив, состоящий из статусов запросов. Статус может быть равен
'ERROR', 'SUCCESS', 'LOADING'

`refetchMessages` – объект с параметрами для [кнопки "Перезапросить данные"](./personal-menu/product-list/refetch-button/index.jsx)

| param       | description                    | default                                   |
|-------------|--------------------------------|-------------------------------------------|
| title       | Локаль для главной надписи     | Повторите загрузку или зайдите чуть позже |
| description | Локаль для серой надписи внизу | Не удалось загрузить данные               |

Пример работы можно посмотреть в компонентах [Брокерское обслуживание](./personal-menu/product-list/brokerage-list.jsx),
[Кредиты](./personal-menu/product-list/loan-list.jsx)

#### Темизация

Теперь все элементы в продуктовом регионе окрашиваются в разные темы. Темы задаются через платформу и дизайнеров.
Можно задать разные цвета иконкам, как это сделать, см. п. __Иконки в теме__.

#### Иконки в теме

Компонент для вставки иконок переехал из @sbol/lib.ui в @sbol/design.system. 
В новом компоненте есть проп colorScheme, которым теперь красятся иконки.
Все иконки из дизайн-системы должны быть утвержены дизайнерами, см. п. __TL;DR__

В продуктах мы используем компонент 
на основе [RegularIcon](./personal-menu/single-product/single-product-icon/product-icon-component/regular-icon/index.jsx).

Он реагирует на переключение темы и управляет иконками по следующим правилам:

* __MONO__: иконка черно-белая, она должна быть черной на светлой теме и белой – на темных.
* __GRAY__: иконка серая, на темной теме она становится полупрозрачной.
* __DEFAULT__: если тип не указан, либо он отличен от предыдущих двух, иконка вставляется as is.
например, если иконка цветная - на всех темах она будет одинаковая

Иконка получает тип GRAY если проп colorScheme из селектора (см. п. __Параметры продукта__) указан как константа [GHOST_COLOR](./style-constants.js),
MONO – если не указан colorScheme и если это не карты. Если указан colorScheme, значит, иконка цветная,
отображаться на всех темах будет одинаково.

По умолчанию все иконки __MONO__.

#### Статусы продуктов

Все иконки статусов указаны на [макете](https://zpl.io/VOOKoAl).
Чтобы отобразить иконку, необходимо передать в проп `notification` (см. п. Параметры продукта)
следующие [константы](./personal-menu/utils/constants.js) (значения соответствуют порядку отображения в макете)

| type           | description          |
|----------------|----------------------|
| WAITING        | __MONO__ часы            |
| BAD_ATTENTION  | оранжевый "!"        |
| WARNING        | __MONO__ "!"             |
| GOOD_ATTENTION | зеленый "!"          |
| READY          | зеленая галочка      |
| ARRESTED       | красный "!"          |
| REPEAT         | __MONO__ круглая стрелка |

Если вместе с иконкой требуется покрасить и текст, можно воспользоваться пропом `message.style`,
[пример](./__data__/selectors/products/cards/utils.js) см.  функцию getNotification.

#### Свойства платформы

avatar.url.small - url до статических ресурсов аватара

#### FAQ

###### Мне нужен лончер

Добавляем тестовую конфигурацию в [stub/api/launcher](../stub/api/launcher.json), используем getFeatureOption.

Если вы добавили какую-то фичу, обязательно нужно добавить ее в репозиторий [WebConfigurationTest](https://sbtatlas.sigma.sbrf.ru/stash/projects/LCFG/repos/webconfigurationtest/browse).

##### Как это сделать: 
В случае, если в репозитории уже висит пулл-реквест с новой конфигурацией region.scaffold, 
можно запушить свою конфигурацию прямо в эту ветку. Если пулл-реквеста нет, нужно выполнить следующие действия:

1. Клонируем мастер репозитория, или `git checkout master && git pull` (! Обязательно)
2. Смотрим, какая версия самая старшая по номеру в папке `region.scaffold`
3. `node next-version.js`
4. Выполняем рекомендацию скрипта
5. Заходим в новую папку с новой конфигурацией и правим файлы
6. Делаем пулл-реквест

###### Мой продукт выглядит иначе

Добавляем в [single-product/single-product-info](./personal-menu/single-product/single-product-info/index.jsx) свой тип продукта и компонент

###### Мне нужно создать вложенные меню

Используйте компонент [SandwichLists](personal-menu/sandwich-lists/index.jsx).

| param           | type    | isRequired | description                                                                                                             |
|-----------------|---------|------------|-------------------------------------------------------------------------------------------------------------------------|
| title           | String  | •          | название категории                                                                                                      |
| children        | Node    | •          | дочерний компонент                                                                                                      |
| newProductUrl   | String  |            | Урл кнопки "+"                                                                                                          |
| newProductTitle | String  |            | title для доступности плашки с названием продукта                                                                       |
| onListClick     | func    |            | Коллбэк для открытия вкладки                                                                                            |

Пример:

```
<SandwichLists
    {...данные из селектора аналогично таблице выше}
>
    <CardList {...cards} newProductTitle={i18next.t('region.scaffold:card.ghost.title')} />
    <LoansList {...loans} newProductTitle={i18next.t('region.scaffold:card.ghost.title')} />
</SandwitchLists>
```
