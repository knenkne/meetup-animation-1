# Логирование

## Включение

По настройке `log.level` и по наличию настройки `log.url`
модуль декорирует методы console в соответствии
с уровнями логирования loglevel.

Переопределенные методы console получают возможность добавлять
сообщения в очередь на отправку (пакетирование).

Дополнительно добавляются обработчики на всплытие и переопределяются
методы XHR, чтобы логировать:
* ошибки html (загрузка картинок, скриптов)
* необработанные ошибки js (если они в потоке и не были обработаны ранее)
* XHR (объект запроса дополняется необходимыми атрибутами)

__Примечание__: XHR логируются в info; XHR с ошибкой и XHR
с непустым массивом errors в ответе логируются в error.

## Формирование logMessage

Перед добавлением в очередь все аргументы console методов
проходят форматирование согласно [спецификации](https://sbtatlas.sigma.sbrf.ru/wiki/display/~16727342/PL+Front+global+logger+-+proposal).

* `level` - уровень вызванного метода console
* `timestamp` - время добавления в очередь
* `location` - URL возникновения лога
* `message` - сериализованное сообщение (все аргументы метода консоли)

Опциональные параметры
(если в аргументах лога найдены соответствующие объекты):

* Объект типа `ModuleId` (в аргументах есть объект `{ __moduleId: 'catalog' }`)
  * `moduleId - берется значение этого объекта
* Объект типа `Error`
  * `errorStack - stack trace ошибки
  * `errorMessage - сообщение ошибки
* Объект типа `XmlHttpRequest`
  * `responseStatus` - статус ответа
  * `requestMethod` - http-метод запроса
  * `requestUrl` - URL запроса
  * `requestBody` - тело запроса
  * `responseBody` - тело ответа
  * ~~`requestHeaders`~~ - заголовки запроса (пока не требуются)
  * ~~`responseHeaders`~~ - заголовки ответа (пока не требуются)

## Пакетирование

[Документация](https://sbtatlas.sigma.sbrf.ru/wiki/pages/viewpage.action?pageId=1781601040)

Новые сообщения добавляются в очередь на отправку.
Каждый пакет отправляется по достижению одного из триггеров:

* Время простоя пополнения логов,
  определяется настройкой `frontend.log.timeout`

  Default: 30000

* Максимальный размер пакета (в сообщениях),
  определяется настройкой `frontend.log.batch.capacity`

  Default: 10

* Закрытие/обновление страницы

Пакет каждый раз сопровождается дополнительно:
* `userAgent` - информация о браузере клиента
* `channel` - канал логирования (SBOL.WEB, SBOL.PRO)

Если пакет не удалось отправить, он возвращается в очередь.

## Переопределение логов запросов

В логах могут участвовать чувствительные клиентские данные.
Если в объекте XHR определены методы ниже, они будут применены
к соответствующим доменам данных:

* `modifyRqUrl` - модификатор URL
* `modifyRq` - модификатор тела запроса
* `modifyRs` - модификатор тела ответа

## Игнорирование логов

Логи запросов по URL `//scr.online.sberbank.ru/` игнорируются.
Данный модуль должен быть расширен и настраиваемым.

## Пример логов
```
{
  "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36",
  "channel": "SBOL.WEB",
  "messages": [
    {
      "level": "info",
      "timestamp": "2020-03-02T16:19:33.723+0300",
      "location": "http://localhost:4242/foo",
      "message": "",
      "responseStatus": 200,
      "requestUrl": "http://localhost:4242/sockjs-node/info?t=1583155173654",
      "requestHeaders": "{}",
      "responseHeaders": "{}"
    },
    {
      "level": "info",
      "timestamp": "2020-03-02T16:19:33.745+0300",
      "location": "http://localhost:4242/foo",
      "message": "",
      "responseStatus": 200,
      "requestUrl": "/api/init",
      "requestBody": "{\"id\":\"foo.dashboard\"}",
      "requestHeaders": "{}",
      "responseHeaders": "{}"
    }
  ]
}
```
