# Стратегии

Стратегии предназначены для возможности более гибкого использования виджетов воркфлоу в связке.
Стратегии описывают бизнес логику, взаимодействие со слоем данных осуществляется посредством протоколов.

## Типы стратегий
1. Стандартные стратегии входят в библиотеку воркфлоу, поддерживаются платформой
2. Кастомные стратегии разрабатываются и поддерживаются командами прикладных проектов

## Стандартные стратегии
 Стандартные стратегии описаны здесь [Стратегии. Описание реализации](https://sbtatlas.sigma.sbrf.ru/wiki/pages/viewpage.action?pageId=2312013635). <br> 
 Из базовых стратегий в вебе на текущий момент поддерживается стратегия resourceMoney, описанная на странице выше.
Эта стратегия позволяет связывать инструмент списания (CoreResource) с полем суммы, и в случае если сумма списания превышает текущий остаток выставляет валидатор в сответствии со стратегией для поля с fieldLookupId

Стратегия divider в настоящее время не поддерживается в вебе, поскольку дивайдеры отсутствуют в дизайне веба

## Кастомные стратегии 
Кастомные стратегии представляют из себя функции, они описываются в коде прикладного проекта и пробрасываются в пропс customStrategies
компонента Workflow объектом.
Объект составляется следующим образом
```
const customStrategies = {
    customVisibility
}
```
customVisibility - это название кастомной стратегии, в данном случае это пример стратегии позволяющей скрывать виджет в зависимости от значения одного и более полей.
Это название должно совпадать с названием стратегии которая приходит с БХ для одного из виджетов к которому она применяется.

В кастомных стратегиях реализуется бизнес логика по связыванию между собой разных полей <br>
Стратегии могут изменять состояние приложения посредством вызова стандартных протоколов воркфлоу и устанавливать валидаторы на определенные поля по их id.
Изменение состояния осуществляется посредством вызова стандартных протоколов воркфлоу.
Стратегия - это функция с сигнатурой:
```
    const fn = ({ state, properties, widgetPlace, fieldLookupId, formValues }) => {}
```
state - состояние приложения
properties -  свойства стратегии из ответа бх
widgetPlace - объект положение виджета состоит из screenIndex, screenPart, widgetIndex
fieldLookupId - id поля из стратегии

На уровне филдов валидаторы стратегий сетятся в компоненте StrategyField.

чтобы установить валидатор для определенного поля из стратегии нужно вернуть объект 
```
    {
        strategyValidators: {
            [fieldId]: [fn]  // ключ - айдишник филда к которому будет применяться валидатор, значание - массив функций валидаторов для redux-form
        }
    }
```

Пример кастомной стратегии: [здесь](../../../fixture/src/custom-strategies)

## Протоколы

Реализованы следующие протоколы:
1. ```getAmount``` - протокол получения значения поля по его id если в этом поле референсы, то протокол возвращает properties?.amount из референсов
2. ```getWidgetTitleByFieldId``` - возвращает значение title виджета содержащего филд с определенным id
3. ```subscribeToFieldValueById``` - возвращает value поля по его fieldLookupId
4. ```updateFieldValue``` - изменяет значение филда по его id
5. ```updateWidgetTitle``` - обновляет значение title виджета по id филда лежащего в виджете
